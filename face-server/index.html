<!DOCTYPE html>
<html>
<head>
  <title>Giant Emoji – Final Complete</title>
  <style>
    html,body{
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      background:black;
      overflow:hidden;
    }
    canvas{display:block;}
  </style>
</head>

<body>
<canvas id="canvas"></canvas>

<script>
/* ================= CANVAS ================= */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
window.addEventListener("resize", resize);

/* ================= STATE ================= */
let fx = canvas.width/2, fy = canvas.height/2;
let tx = fx, ty = fy;
let R = Math.min(canvas.width, canvas.height) * 0.28;

let le = 1, re = 1;
let browL = 0, browR = 0;
let mouthOpen = 0, mouthWidth = 0;
let state = "neutral";
let pupilX = 0, pupilY = 0;

/* ================= WEBSOCKET ================= */
const socket = new WebSocket("wss://fantasy-api.online/face");

socket.onopen = () => {
  console.log("✅ WebSocket connected");
};

socket.onerror = err => {
  console.error("❌ WebSocket error", err);
};

socket.onmessage = e => {
  const d = JSON.parse(e.data);
  if (!d.face_center) return;

  tx = canvas.width * (1 - d.face_center.x);
  ty = canvas.height * d.face_center.y;

  le = Math.abs(d.left_eye_u.y - d.left_eye_l.y) * 40;
  re = Math.abs(d.right_eye_u.y - d.right_eye_l.y) * 40;

  browL = (d.left_eye_u.y - d.left_brow.y) * 180;
  browR = (d.right_eye_u.y - d.right_brow.y) * 180;

  mouthOpen = Math.abs(d.mouth_top.y - d.mouth_bottom.y);
  mouthWidth = Math.abs(d.mouth_left.x - d.mouth_right.x);

  if (mouthWidth > 0.09 && mouthOpen < 0.02) state="smile";
  else if (mouthOpen > 0.13) state="surprise";
  else if (mouthOpen > 0.10) state="tongue";
  else if (mouthOpen > 0.045) state="open";
  else if (browL < -15 && browR < -15) state="angry";
  else state="neutral";

  pupilX = (d.face_center.x - d.nose.x) * 45;
  pupilY = (d.nose.y - d.face_center.y) * 45;
};

/* ================= CAMERA STREAM ================= */
navigator.mediaDevices.getUserMedia({ video: true })
.then(stream => {
  const video = document.createElement("video");
  video.srcObject = stream;
  video.play();

  const camCanvas = document.createElement("canvas");
  const camCtx = camCanvas.getContext("2d");

  setInterval(() => {
    if (socket.readyState !== WebSocket.OPEN) return;

    camCanvas.width = video.videoWidth;
    camCanvas.height = video.videoHeight;
    camCtx.drawImage(video, 0, 0);

    const frame = camCanvas
      .toDataURL("image/jpeg", 0.6)
      .split(",")[1];

    socket.send(frame);
  }, 30); // ~30 FPS
})
.catch(err => {
  alert("Camera access denied");
  console.error(err);
});

/* ================= DRAW HELPERS ================= */
function drawEye(x,y,open){
  const h = Math.max(4, open*16);

  ctx.fillStyle="#FFD400";
  ctx.beginPath();
  ctx.ellipse(x,y-6,38,22,0,0,Math.PI*2);
  ctx.fill();

  ctx.fillStyle="white";
  ctx.beginPath();
  ctx.ellipse(x,y,34,h,0,0,Math.PI*2);
  ctx.fill();

  ctx.fillStyle="black";
  ctx.beginPath();
  ctx.arc(x+pupilX,y+pupilY,8,0,Math.PI*2);
  ctx.fill();
}

function drawBrow(x,y,lift){
  ctx.strokeStyle="black";
  ctx.lineWidth=6;
  ctx.lineCap="round";
  ctx.beginPath();
  ctx.moveTo(x-34,y+lift);
  ctx.quadraticCurveTo(x,y-26+lift,x+34,y+lift);
  ctx.stroke();
}

/* ================= MOUTH SHAPES ================= */
function mouthNeutral(){
  ctx.beginPath();
  ctx.moveTo(fx-36,fy+R*0.36);
  ctx.lineTo(fx+36,fy+R*0.36);
  ctx.stroke();
}

function mouthSmile(){
  ctx.beginPath();
  ctx.moveTo(fx-38,fy+R*0.36);
  ctx.quadraticCurveTo(fx,fy+R*0.36+6,fx+38,fy+R*0.36);
  ctx.stroke();
}

function mouthOpenShape(){
  ctx.beginPath();
  ctx.ellipse(fx,fy+R*0.36,38,18,0,0,Math.PI*2);
  ctx.stroke();
}

function mouthTongue(){
  ctx.beginPath();
  ctx.ellipse(fx,fy+R*0.36,38,22,0,0,Math.PI*2);
  ctx.stroke();

  ctx.fillStyle="#ff5c5c";
  ctx.beginPath();
  ctx.ellipse(fx,fy+R*0.58,16,38,0,0,Math.PI*2);
  ctx.fill();

  ctx.strokeStyle="#e04848";
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(fx,fy+R*0.52);
  ctx.lineTo(fx,fy+R*0.68);
  ctx.stroke();
}

function mouthAngry(){
  ctx.beginPath();
  ctx.moveTo(fx-34,fy+R*0.36);
  ctx.quadraticCurveTo(fx,fy+R*0.36-6,fx+34,fy+R*0.36);
  ctx.stroke();
}

function mouthSurprise(){
  ctx.beginPath();
  ctx.ellipse(fx,fy+R*0.36,22,30,0,0,Math.PI*2);
  ctx.stroke();
}

/* ================= DRAW LOOP ================= */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  fx += (tx-fx)*0.06;
  fy += (ty-fy)*0.06;
  R = Math.min(canvas.width,canvas.height)*0.28;

  ctx.fillStyle="#FFD400";
  ctx.beginPath();
  ctx.arc(fx,fy,R,0,Math.PI*2);
  ctx.fill();

  drawBrow(fx-R*0.35,fy-R*0.44,browL);
  drawBrow(fx+R*0.35,fy-R*0.44,browR);

  drawEye(fx-R*0.35,fy-R*0.25,le);
  drawEye(fx+R*0.35,fy-R*0.25,re);

  ctx.fillStyle="black";
  ctx.beginPath();
  ctx.moveTo(fx,fy-8);
  ctx.lineTo(fx-10,fy+18);
  ctx.lineTo(fx+10,fy+18);
  ctx.fill();

  ctx.strokeStyle="black";
  ctx.lineWidth=4;

  if(state==="smile") mouthSmile();
  else if(state==="open") mouthOpenShape();
  else if(state==="tongue") mouthTongue();
  else if(state==="angry") mouthAngry();
  else if(state==="surprise") mouthSurprise();
  else mouthNeutral();

  requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
